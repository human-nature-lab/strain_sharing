---
title: "Network Comparison"
author: "Francesco Beghini"
date: "2023-12-21"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source(file = 'deltacon.R')
library(foreach)
```

```{r}
strain_rate_vil_graph_1
sn_vil_graph_1
resample_graph <- function(g){
  return(rewire(g, keeping_degseq(niter = ecount(g)*10)))
}

asd = boot::boot(strain_rate_vil_graph_1, R=1000, parallel = 'multicore', statistic = function(x, ...){ 
  tmp = rewire(x, keeping_degseq(loops = FALSE, niter = ecount(x)*10)) 
  centralization.betweenness(tmp)$centralization
  })
asd1 = boot::boot(sn_vil_graph_1, R=1000, parallel = 'multicore', statistic = function(x, ...){ 
  tmp = rewire(x, keeping_degseq(loops = FALSE, niter = ecount(x)*10)) 
  centralization.betweenness(tmp)$centralization
  })

sdiff <- asd$t - asd1$t
diff_ci <- quantile(sdiff, probs = c(0.025, .975))
```

```{r}

foreach(i=1:length(village_names), .combine = 'rbind') %do% {
  sn_g <- get(paste0('sn_vil_graph_',i))
  st_g <- get(paste0('strain_rate_vil_graph_',i))
  sn_adj <- as_adjacency_matrix(sn_g, sparse = FALSE)
  sn_adj <- sn_adj[sort(rownames(sn_adj)),sort(colnames(sn_adj))]
  st_adj <- as_adjacency_matrix(st_g, sparse = FALSE)
  st_adj <- st_adj[sort(rownames(st_adj)),sort(colnames(st_adj))]
  
  all_nodes <- sort(V(sn_g)$name)
  
  edg_sn <- data.frame(as_edgelist(sn_g))
  edg_st <- data.frame(as_edgelist(simplify(st_g)))
  colnames(edg_sn) <- c('src','dst')
  colnames(edg_st) <- c('src','dst')
  edg_sn$src <- match(edg_sn$src, all_nodes)
  edg_sn$dst <- match(edg_sn$dst, all_nodes)
  edg_st$src <- match(edg_st$src, all_nodes)
  edg_st$dst <- match(edg_st$dst, all_nodes)
  
  data.frame(village_code = village_names[i],
       village_name = village_map[village_map$village_code==village_names[i],'village_name_deid'][[1]],
       no_components_social_network = count_components(sn_g),
       no_components_strain_transmission = count_components(st_g),
       clustering_coefficient_social_network = transitivity(sn_g, type = "global", isolates = 'zero'),
       clustering_coefficient_strain_transmission = transitivity(st_g, type = "global", isolates = 'zero'),
       average_shortest_path_social_network = mean_distance(sn_g, directed = FALSE),
       average_shortest_path_strain_transmission = mean_distance(st_g, directed = FALSE),
       L2 = norm(sn_adj - st_adj, type = '2'),
       discrete_spectral_distance = NetworkDistance::nd.dsd(list(sn_adj, st_adj))$D[[1]],
       delta_con = delta_con(edg_sn, edg_st, nnodes = length(all_nodes), method = 'naive', symmetrical = TRUE, seed = 1993))
} -> graph_distances

graph_distances
```
```{r}
writexl::write_xlsx(graph_distances, 'tables/graph_distances.xlsx')
```
```{r}
par(mfrow=c(3,2))
for (i in 1:length(village_names)) {
  igraph::plot.igraph(get(paste0('sn_vil_graph_',i)),
                      vertex.label = NA, 
                      vertex.size = 5,
                      layout = layout.fruchterman.reingold(get(paste0('sn_vil_graph_',i))), 
                      edge.width = E(get(paste0('sn_vil_graph_',i)))$width,
                      main = paste( village_map[village_map$village_code==village_names[i],'village_name_deid'][[1]], village_names[i])
                      )
}
```
```{r}

```

